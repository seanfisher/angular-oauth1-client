/*! angular-oauth1-client - v0.1.10 - 2016-02-01
* Copyright (c) 2016 Sean Fisher; Licensed MIT */
!function(a,b,c){"use strict";b.module("oauth1Client",["LocalStorageModule"]).service("oauthPersistence",["localStorageService","$q",function(a,b){var c=this,d="oauth_token",e="oauth_token_secret";c.storeAccessToken=function(c){var f=b.defer();return a.set(d,c.oauth_token),a.set(e,c.oauth_token_secret),f.resolve(),f.promise},c.clearAccessToken=function(){a.remove(d),a.remove(e)},c.accessIsInStorage=function(b,c){a.get(d)&&a.get(e)?b():c()},c.getTokenAndSecret=function(b){b(a.get(d),a.get(e))}}]).factory("oauth1Signer",[function(){function a(a){for(var b="",c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",d=0;a>d;d++)b+=c.charAt(Math.floor(Math.random()*c.length));return b}return{create:function(b){return _.extend({token:null,tokenSecret:"",version:"1.0",signatureMethod:"HMAC-SHA1",method:"GET",timestamp:Math.floor(Date.now()/1e3),nonce:a(32),oauthParameters:function(){var a,b;return a=this,b={oauth_consumer_key:a.consumerKey,oauth_nonce:a.nonce,oauth_timestamp:a.timestamp,oauth_signature_method:a.signatureMethod},a.token&&(b.oauth_token=a.token),a.version&&(b.oauth_version=a.version),a.callbackUrl&&(b.oauth_callback=a.callbackUrl),a.verifier&&(b.oauth_verifier=a.verifier),a.scopes&&(b.scopes=a.scopes),b},queryStringFields:function(){var a,b,c;return a=this,b=a.oauthParameters(),c=a.fields,_.each(_.keys(c),function(a){return b[a]=c[a]}),b},queryString:function(){var a,b,c;a=this,b=a.queryStringFields(),c=_.keys(b).sort();var d=_.map(c,function(c){return c+"="+a.percentEncode(b[c])}).join("&");return d},urlEncoded:function(a){return _.map(_.keys(a),function(b){return b+"="+encodeURIComponent(a[b])}).join("&")},headerEncoded:function(a){return _.map(_.keys(a),function(b){return b+'="'+encodeURIComponent(a[b])+'"'}).join(", ")},urlEncodedFields:function(){var a;return a=this,a.urlEncoded(a.fields)},authorizationHeader:function(){var a,b;return a=this,b=a.oauthParameters(),b.oauth_signature=a.base64Signature(),a.headerEncoded(b)},urlAndFields:function(){var a,b;return a=this,b=a.urlEncodedFields(),b?a.url+"?"+b:a.url},parameterEncoded:function(a){var b=this,c=_.map(a,function(a){return b.percentEncode(a)}).join("&");return c},baseString:function(){var a;return a=this,a.parameterEncoded([a.method,a.url,a.queryString()])},hmacKey:function(){var a;return a=this,a.parameterEncoded([a.consumerSecret,a.tokenSecret])},hmac:function(a){var b,c;if(b=a&&a.hasOwnProperty("encoding")&&void 0!==a.encoding?a.encoding:"binary",c=this,"undefined"!=typeof process){var d,e;return d=require("crypto"),e=d.createHmac("sha1",c.hmacKey()),e.update(c.baseString()),e.digest(b)}var f;return f=CryptoJS.HmacSHA1(c.baseString(),c.hmacKey()),"base64"===b?f.toString(CryptoJS.enc.Base64):f},base64Signature:function(){var a;return a=this,a.hmac({encoding:"base64"})},signature:function(){var a;return a=this,a.percentEncode(a.base64Signature())},signedUrl:function(){var a;return a=this,a.url+"?"+a.queryString()+"&oauth_signature="+a.signature()},curl:function(){var a;return a=this,"GET"===a.method()?"curl '"+a.url+"?"+a.queryString()+"&oauth_signature="+a.signature()+"'":"POST"===a.method()||"PUT"===a.method()?a.body()?"curl -X "+a.method()+" '"+a.urlAndFields()+"' -d '"+a.body()+"' -H 'Authorization: "+a.authorizationHeader()+"' -H 'Content-Type: "+a.bodyEncoding()+"'":"curl -X "+a.method()+" '"+a.url+"' -d '"+a.queryString()+"&oauth_signature="+a.signature()+"'":"curl -X DELETE '"+a.url+"?"+a.queryString()+"&oauth_signature="+a.signature()+"'"},percentEncode:function(a){return encodeURIComponent(a).replace(/\*/g,"%2A")}},b)}}}]).provider("oauth1Client",function(){function c(a,b){var c=new RegExp("[?|&]?"+b+"=([^&;]+?)(&|#|;|$)"),d=c.exec(a);return d=d?d[1]:"",decodeURIComponent(d.replace(/\+/g,"%20"))||null}var d,e,f,g,h,i,j,k,l;this.config=function(a){d=a.consumerKey,e=a.consumerSecret,f=a.requestEndpoint,g=a.authorizeEndpoint,h=a.accessEndpoint,i=a.oauthCallback,l=a.scopes},"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(a){return 0===this.indexOf(a)}),this.$get=["$q","$http","oauth1Signer","oauth1Headers","oauth1AuthorizedHttp","oauthPersistence",function(m,n,o,p,q,r){function s(a){return o.create(a)}function t(a,b){var d=m.defer();return n.get(a.signedUrl()).success(function(a,b,e,f){d.resolve({oauth_token:c(a,"oauth_token"),oauth_token_secret:c(a,"oauth_token_secret"),oauth_callback_confirmed:c(a,"oauth_callback_confirmed")})}).error(function(a,b,c,e){alert("getRequestTokenError: "+JSON.stringify(a)),d.reject("getRequestTokenError: "+JSON.stringify(a))}),d.promise}function u(d,e,f,h,i){var j=m.defer(),k=g+"?oauth_token="+d+"&oauth_callback="+e,l=a.open(k,"_blank","location=no,clearcache=yes,hidden=yes"),n=!1;return l.addEventListener("loadstart",function(a){a.url.startsWith(e)&&(b.isFunction(h)&&h(),l.close(),j.resolve({returned_oauth_token:c(a.url,"oauth_token"),oauth_verifier:c(a.url,"oauth_verifier")}))}),l.addEventListener("loadstop",function(a){b.isFunction(i)&&i(l,a),n||(l.show(),n=!0),b.isFunction(f)&&f()}),j.promise}function v(a){var b=m.defer();return n.post(a.signedUrl()).success(function(a,d,e,f){b.resolve({oauth_token:c(a,"oauth_token"),oauth_token_secret:c(a,"oauth_token_secret")})}).error(function(a,c,d,e){alert("getAccessTokenError: "+JSON.stringify(a)),b.reject("getAccessTokenError: "+JSON.stringify(a))}),b.promise}function w(a,b){var c=b.oauth_token,g=b.oauth_token_secret,h=s({url:f,consumerKey:d,consumerSecret:e,token:c,tokenSecret:g});p.create(h),a(q.create(h))}return{oAuthSigner:function(a){r.getTokenAndSecret(function(b,c){a(s({url:f,consumerKey:d,consumerSecret:e,token:b,tokenSecret:c}))})},authorize:function(a,b,c){var g=m.defer(),n=s({url:f,consumerKey:d,consumerSecret:e,callbackUrl:i,scopes:l});n.oauthParameters();return t(n,i).then(function(d){return j=d.oauth_token,k=d.oauth_token_secret,u(d.oauth_token,i,a,b,c)}).then(function(a){return n=s({url:h,consumerKey:d,consumerSecret:e,method:"POST",token:j,tokenSecret:k,verifier:a.oauth_verifier}),v(n)}).then(function(a){r.storeAccessToken(a).then(function(){w(function(a){g.resolve(a)},a)})},function(a){alert("Error: "+JSON.stringify(a)),g.resolve({error:JSON.stringify(a)})}),g.promise}}}]}).service("oauth1AuthorizedHttp",["$http","$q",function(a,b){return{create:function(c){this.oauth1Signer=c;var d=this;return function(c){d.oauth1Signer.method=c.method||"GET",d.oauth1Signer.url=c.url,a.defaults.headers.common.Authorization="OAuth "+d.oauth1Signer.authorizationHeader(),a.defaults.headers.common["Content-Type"]="application/x-www-form-urlencoded; charset=UTF-8";var e=b.defer();return a(c).then(function(a){a.data.authToken=d.oauth1Signer.token,e.resolve(a)},function(a){e.reject(a)}),e.promise}}}}]).service("oauth1Headers",["$http",function(a){return{create:function(a){this.oauth1Signer=a},getHeaders:function(a,b){var c=this;return c.oauth1Signer?(c.oauth1Signer.method=b,c.oauth1Signer.url=a,{Authorization:"OAuth "+c.oauth1Signer.authorizationHeader(),"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}):{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}},removeAuthorizationHeader:function(){a.defaults.headers.common.Authorization=c}}}])}(window,window.angular);